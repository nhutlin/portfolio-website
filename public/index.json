
[{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/categories/automation/","section":"Categories","summary":"","title":"Automation","type":"categories"},{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"\rComming soon\u0026hellip; #\r","date":"22 March 2025","externalUrl":null,"permalink":"/posts/202109-the-future-of-nintendo/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eComming soon\u0026hellip; \r\n    \u003cdiv id=\"comming-soon\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n    \u003cspan\r\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\r\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\r\n            style=\"text-decoration-line: none !important;\" href=\"#comming-soon\" aria-label=\"Anchor\"\u003e#\u003c/a\u003e\r\n    \u003c/span\u003e        \r\n    \r\n\u003c/h2\u003e\r\n\u003c!-- ![Super Nintendo](supernintendo.jpg)\r\n\r\nNintendo is a Japanese multinational consumer electronics and video game company with headquarters in Kyoto, Japan. In its annual report for 2021, the company reported a revenue of $16 billion (¥1,759 trillion) and it currently employs around six thousand people around the world across several different business units. \r\n\r\nNintendo was founded in 1889 as a company that produced and distributed hanafuda, a traditional Japanese card game. During the first half of the 1900s, the company tried to diversify into several different markets with little to no success (e.g. instant rice, love hotels, and a taxi service). During the 60s to 80s, Nintendo started investing in games, electronic toys, and gaming entertainment.\r\n\r\nAll of these investments culminated in the 90s with the launch of the Super Nintendo Entertainment System which sold around 50 million units worldwide and helped the company enter the US market. By then Nintendo had built several valuable assets in hardware, software, and intellectual property (including the most famous plumber that ever lived, Mario).\r\n\r\nAfter the Super Nintendo, the company continued to release new games and gaming devices throughout the 90s and into the 00s, including the Gameboy, Nintendo 64, GameCube, and the Wii in 2006, which contributed to make Nintendo a force to be reckoned in the gaming industry with net sales that peaked at $18 billion in 2009.\r\n\r\n![Nintendo Net Sales](netsales.png)\r\n\r\nIn 2010, the previous generation of hardware Wii was approaching the end of its life cycle and coincidentally the company’s annual net sales started dropping. At the end of 2012 the company launched its next-generation gaming console that would replace the Wii, the Wii U. However, the Wii U was a commercial failure and never got a real foothold in the console market selling less than 15 million units worldwide. The platform was described as expensive, confusing and was never able to attract support from either hardcore nor casual customers leading to Nintendo's sales eventually plummeting to just $4 billion in 2017. \r\n\r\n2017 was also the same year the company was able to disrupt itself and the entire gaming industry with the launch of the Nintendo Switch which until today sold more than 89 million units worldwide, led to a reported $16 billion net sales in 2021, and ultimately contributed to save Nintendo and establish it once again as one of the biggest players in the game industry.\r\n\r\n## The Switch's Disruption\r\n\r\n![Nintendo Switch](console.jpeg)\r\n\r\nThe Switch entered the market as the first console that was built from the ground up to provide a hybrid experience between mobile and living room gaming (or at least the first one that was actually able to deliver that experience). This hybrid setup allowed Nintendo to create different gaming modes from connecting the Switch to a TV using a dock, to connecting the controls to the main unit and taking it to play on the go. Additionally, the actual remote of the console can be used as two separate controlling devices which allows two players to enjoy a game at once. All these different modes and combinations made the switch a super attractive console for families and casual gamers since it was an affordable and flexible option when compared to the rest of the hardware available.\r\n\r\nA problem that Nintendo had to solve was the fact that launching a gaming console entails an interdependency between the actual hardware and its games. Or in other words, a console is only as valuable as the catalog of games available for it. To solve this problem, Nintendo adopted an integrated strategy in order to launch the Switch with a great catalog of games focusing on the same segment that the hardware features of the console were targeting. Nintendo developed several of the initial games and leveraged its valuable intellectual property of characters and stories to sell the Switch i.e. Mario, Zelda, etc. \r\n\r\nThe Switch is a traditional example of a new-market disruption. Nintendo was targeting casual gamers (non-consumption for the traditional gaming industry) by offering a product that was inferior when compared to the other consoles in the market using the metrics from that time (graphics power, storage, etc) but superior when using the new set of metrics important to the new segment (fun, flexible, casual, affordable, etc). The fact that the Switch was not a super powerful device led to Sony and Microsoft not seeing Nintendo as a real competitor since their performance metrics were focused on high-end gamers and AAA titles. This created an asymmetric motivation, meaning that the incumbent companies simply conceded that market to Nintendo as it was not interesting for them. Ultimately, Nintendo gained market share with the Switch selling over 80 million units worldwide. At the moment other players still do not have the incentives to compete in that market and even if they did, they would not be able to because neither of them is competing on the same performance metrics as the Switch nor with the same organization and business structure that would allow them to succeed.\r\n\r\n![Nintendo Switch Lite](lite.png)\r\n\r\nIn July 2019, Nintendo decided to launch a cheaper version of the product called the Switch Lite, this was a clear example of the company disrupting itself. Namely, Nintendo created a low-end disruption over its own product by creating a cheaper “good enough” product that targets over-served customers of the original Switch. This created a strong foothold on the low-end market for video games which is hard to compete against.\r\n\r\nCurrently, Nintendo and the Switch are in a phase of sustaining innovation where incremental performance improvements in attributes are provided to the more valuable/demanding customers in the market. The proof of this is the next version of the console, due to launch in October 2021, the Nintendo Switch OLED, which is basically the same as the current Switch with a bigger screen, bigger battery, and more internal storage. This makes complete sense from a strategic point of view, after defining and deploying such a successful product, Nintendo is focusing on a deliberate strategy to grow its market share and meet the needs of its best customers in order to beat the competition, not that there is actually one at the time.\r\n\r\n## What's Next for Nintendo and the Switch?\r\n\r\n![Nintendo Switch OLED](olde.jpeg)\r\n\r\nCurrently, the Switch is already the 7th best selling console of all time and the 2nd best selling handheld gaming device of all time with 89 million units sold worldwide. Considering just the consoles still in the market, the Switch has already become the number 2 device in just 4 years. \r\n\r\n![Best Selling Consoles](chart.png)\r\n\r\nIt is expected that, for the time being, Nintendo will retain its position in the market and keep evolving the Switch and its ecosystem with new incremental improvements. Companies like Sony and Microsoft which are targeting the high-end gamer segment will not be able to compete with Nintendo due to the humongous differences in the structures of their businesses and organization. Moreover, the other organizations also do not have any incentive to try to compete in the same market as Nintendo because, from their point of view, it is a lower margin market than the one they already have which creates an asymmetric motivation for them to flee up, conceding the low-end without fighting over it. Finally, Nintendo will have a huge advantage over new competitors that tackle its segment and it has every motivation to fight the entrance of new players into its space.\r\n\r\nHowever, there are still points that might require course correction to avoid potential future problems. The first one is the lack of traction from other game developers and publishers in respect to the Switch. Looking at the list of the top 10 best-selling games for the platform only 2 were not developed by Nintendo or one of its subsidiaries. The Switch developer experience has a low barrier to entry (each dev kit costing around $450) but there is a 30% “tax” on each game sold taken from the developers/publishers by Nintendo. The company could potentially look at their developer relationships and explore ways to improve the business model to get a bigger catalog of games faster. A couple of examples would be to help promote games via their channels, or the creation of an indie games program to help and promote smaller companies. Ultimately, this means that in order to grow Nintendo needs to move away from its integrated strategy into a specialized one where it focuses on the most important pieces of the system and in delivering it perfectly i.e. the console, the store, and its IP. But for that, it needs to ensure the right level of modularity so that other developers and publishers can thrive in that space.\r\n\r\nAnother issue with the Switch is the lack of non-gaming applications available in the device that leads to a clash with the main Job-To-Be-Done for the product, “I want entertainment for me and my family”. The Switch has the potential to be the central hub for family entertainment, however, only three video streaming applications are available on the platform: Hulu, Youtube, and Funimation. Working with companies that provide other types of entertainment like Netflix and Disney and helping them launch those services on the Switch would be a great opportunity for Nintendo to improve the feature set of the device and better serve its users. \r\n\r\n![Netflix on Switch](netflix.jpeg)\r\n\r\nRegarding the future, Nintendo is clearly betting on game streaming as a way to move up in the market and disrupt yet again the other players. This would be a great technology to drive the next round of low-end disruption by offering a cheaper way to play AAA games without having to own expensive hardware and upgrade it every one or two years. However, creating its own streaming service might not be the best strategy, Nintendo should look into making its system more modular and potentially partnering with other companies like Google Stadia to get access to streaming capabilities and an existing catalog of games right away. \r\n\r\nUltimately, the common factor across all of Nintendo’s decisions and actions has been the ability to focus on understanding and delivering against the underlying Job-To-Be-Done for its customers. The company was able to understand that the gaming experience could solve the problem (or “job”) of family or party entertainment as well as the standard problems customers hire a gaming device to solve (i.e. play games). By organizing the entire company around these jobs, Nintendo created the ability to target non-consumption and attract a completely different segment of users to its products. Moreover, by implementing an integrated strategy that delivered new hardware, developed new games, and leveraged family-friendly characters known around the world, Nintendo was able to deliver a perfect solution for the job and completely disrupt the gaming industry. In my view, this relentless focus on the customer and how to best solve its problem is why Nintendo has become a Purpose Brand that focuses on providing great family fun and entertainment using technology.\r\n\r\n![The End](end.jpeg)\r\n\r\n## References\r\n\r\n[Henderson, Rik. “What is Nintendo Switch Cloud Streaming, how does it work and what Cloud Version games are there?” Pocket-Lint](https://www.pocket-lint.com/games/news/nintendo/155391-nintendo-switch-cloud-version-streaming-explained-games-list)\r\n\r\n[Herold, Charles. “10 Reasons the Wii U Was a Failure.” Lifewire.](https://www.lifewire.com/reasons-the-wii-u-is-a-failure-2498588)\r\n\r\n[Nintendo. “Nintendo Annual Report FY 2021.”](https://www.nintendo.co.jp/ir/pdf/2021/annual2103e.pdf)\r\n\r\n[Orland, Kyle. “What the “OLED Model” means for the future of Nintendo Switch.” ARS Technica.](https://arstechnica.com/gaming/2021/07/what-the-oled-model-means-for-the-future-of-nintendo-switch/)\r\n\r\n[Peckham, Matt. “19 Things Nintendo's President Told Us About Switch and More.” Time.](https://time.com/4662446/nintendo-president-switch-interview/)\r\n\r\n[Statista. “Nintendo's net sales from fiscal 2008 to 2021.”](https://www.statista.com/statistics/216622/net-sales-of-nintendo-since-2008/)\r\n\r\n[Wikipedia. “List of best-selling game consoles.”](https://en.wikipedia.org/wiki/List_of_best-selling_game_consoles)\r\n\r\n[Wikipedia. “List of best-selling Nintendo Switch video games.”](https://en.wikipedia.org/wiki/List_of_best-selling_Nintendo_Switch_video_games) --\u003e","title":"Installing Kafka Exporter, Postgres Exporter, Redis Exporter, HAProxy Exporter","type":"posts"},{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/","section":"LinhTran's","summary":"","title":"LinhTran's","type":"page"},{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/tags/linux/","section":"Tags","summary":"","title":"Linux","type":"tags"},{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/tags/scripting/","section":"Tags","summary":"","title":"Scripting","type":"tags"},{"content":"","date":"22 March 2025","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"31 October 2024","externalUrl":null,"permalink":"/tags/ansible/","section":"Tags","summary":"","title":"Ansible","type":"tags"},{"content":"","date":"31 October 2024","externalUrl":null,"permalink":"/categories/document/","section":"Categories","summary":"","title":"Document","type":"categories"},{"content":"\rComming soon\u0026hellip; #\r","date":"31 October 2024","externalUrl":null,"permalink":"/posts/202504-install/","section":"Posts","summary":"\u003ch1 class=\"relative group\"\u003eComming soon\u0026hellip; \r\n    \u003cdiv id=\"comming-soon\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n    \u003cspan\r\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\r\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\r\n            style=\"text-decoration-line: none !important;\" href=\"#comming-soon\" aria-label=\"Anchor\"\u003e#\u003c/a\u003e\r\n    \u003c/span\u003e        \r\n    \r\n\u003c/h1\u003e\r\n\u003c!-- - ArXiv: https://arxiv.org/abs/2310.09291\r\n- GitHub: https://github.com/ExplainableML/Vision_by_Language\r\n\r\n**TL;DR**: A training-free, modular, and interpretable approach that leverages LLMs to enhance text-based queries for compositional image retrieval.\r\n\r\n\u003e **Note:** This is my personal learning note, so **some points may not be entirely accurate**. I strive to improve my understanding and will correct any errors I find. If you spot any inaccuracies, please feel free to share your insights to help enhance the content 😊.\r\n\r\n## Summary\r\n\r\nThe paper introduces **CIReVL** (Compositional Image Retrieval through Vision-by-Language), a novel zero-shot compositional image retrieval (ZS-CIR) method. CIReVL leverages existing pre-trained vision-language models (VLMs) and large language models (LLMs) to **perform CIR without any additional training**.\r\n\r\n\r\n## Motivation\r\n\r\nTraditional CIR approaches rely on **supervised training** with annotated triplets (query image, modifying text, target image), which are **expensive and time-consuming** to obtain. Existing ZS-CIR methods often still require training task-specific modules on large image-caption datasets. **CIReVL** addresses these limitations by using **only pre-trained models** in a **modular, interpretable** fashion, offering a more accessible alternative.\r\n\r\n\r\n## Methodology\r\n\r\n![CIReVL Workflow](./cirevl.png)\r\n\r\nCIReVL operates through three main steps:\r\n\r\n1. **Captioning:** A pre-trained VLM (e.g., BLIP-2) generates a detailed caption for the query image.\r\n2. **Reasoning:** An LLM (e.g., GPT-3.5-turbo) processes the generated caption and modification instruction to produce a target caption that reflects the intended changes.\r\n3. **Retrieval:** A second VLM (e.g., CLIP) encodes the target caption and the database images to retrieve the image most similar to the target description.\r\n\r\n\r\n## Why CIReVL Stands Out\r\n\r\n- **Training-Free:** CIReVL doesn’t require any additional training, relying entirely on off-the-shelf pre-trained models, which enhances efficiency and scalability.\r\n- **Modular Design:** This modular approach allows easy replacement or scaling of individual components, enabling exploration of different VLMs and LLMs.\r\n- **Human-Interpretable:** Most of the compositional processing occurs in the language domain, making it interpretable and allowing for human intervention in case of potential errors.\r\n- **State-of-the-Art Performance:** CIReVL matches or surpasses existing training-based and zero-shot methods on several CIR benchmarks, including CIRCO, CIRR, FashionIQ, and GeneCIS.\r\n\r\n\r\n## Conclusion\r\n\r\nCIReVL presents a promising new direction for zero-shot CIR research. Its training-free, modular, and interpretable design, along with its high performance, makes it a compelling approach for future work in ZS-CIR.\r\n\r\n\r\n## Reference\r\n- [Vision-by-Language for Training-Free Compositional Image Retrieval | ICLR 2024](https://arxiv.org/abs/2310.09291) --\u003e","title":"Install Wazuh and Wazuh Agent by Ansible","type":"posts"},{"content":"","date":"31 October 2024","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"These are personal projects I’ve built based on concepts, tools, or practices I’ve worked with in production environments at my company. While they aren’t deployed in production themselves, they reflect real-world challenges and solutions I’ve encountered professionally.\nTitle\rDescription\rReferences\rTimeline\rOpenSCAP Tool\rIntegrating and evaluating OpenSCAP in CI/CD models - Graduation Thesis Project\rsiteGitLab\rJan 2025 - Present\rDevSecOps for Web Application\rImplementing DevSecOps model for E-Commerce Web Application using MERN Stack and Microservices Architecture\rGitLab\rSep 2024 - Dec 2025\rCI/CD models\rResearching and evaluating CI/CD models using Instagram Clone source code\rGitHub\rJan 2024 - May 2024\r","date":"31 October 2024","externalUrl":null,"permalink":"/projects/","section":"LinhTran's","summary":"\u003cp\u003eThese are personal projects I’ve built based on concepts, tools, or practices I’ve worked with in production environments at my company. While they aren’t deployed in production themselves, they reflect real-world challenges and solutions I’ve encountered professionally.\u003c/p\u003e","title":"Projects","type":"page"},{"content":"\rExperience Company\rLink\rRole\rDates\rLocation\rAtom Solution\rDevOps Software Developer\r2024 - Present\rHybrid Ho Chi Minh, VN\rEducation School\rLink\rDegree\rDate\rUniversity of Information Technology - VNUHCM\rBSc, Computer Networking and Data Communication\r2025\rAchievement Conference\rLink\rTitle\rDate\r","date":"31 October 2024","externalUrl":null,"permalink":"/resume/","section":"LinhTran's","summary":"\u003ch2 class=\"relative group\"\u003eExperience \r\n    \u003cdiv id=\"experience\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n\u003c/h2\u003e\r\n\u003ctable\u003e\r\n  \u003cthead\u003e\r\n    \u003ctr\u003e\r\n      \u003cth\u003eCompany\u003c/th\u003e\r\n      \u003cth\u003eLink\u003c/th\u003e\r\n      \u003cth\u003eRole\u003c/th\u003e\r\n      \u003cth\u003eDates\u003c/th\u003e\r\n      \u003cth\u003eLocation\u003c/th\u003e\r\n    \u003c/tr\u003e\r\n  \u003c/thead\u003e\r\n  \u003ctbody\u003e\r\n    \u003c!-- ATOM SOLUTION --\u003e\r\n    \u003ctr\u003e\r\n      \u003ctd rowspan=\"2\"\u003e\u003cimg class=\"customEntitityLogo\" src=\"atom.svg\" /\u003e\u003c/td\u003e\r\n      \u003ctd rowspan=\"2\"\u003e\u003ca href=\"https://atomsolution.vn/\" target=\"_blank\"\u003eAtom Solution\u003c/a\u003e\u003c/td\u003e\r\n      \u003ctd\u003eDevOps Software Developer\u003c/td\u003e\r\n      \u003ctd\u003e2024 - Present\u003c/td\u003e\r\n      \u003ctd\u003eHybrid \u003cbr\u003e Ho Chi Minh, VN\u003c/td\u003e\r\n    \u003c/tr\u003e\r\n  \u003c/tbody\u003e\r\n\u003c/table\u003e\r\n\u003chr\u003e\n\r\n\r\n\u003ch2 class=\"relative group\"\u003eEducation \r\n    \u003cdiv id=\"education\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n\u003c/h2\u003e\r\n\u003ctable\u003e\r\n    \u003cthead\u003e\r\n        \u003ctr\u003e\r\n            \u003cth\u003eSchool\u003c/th\u003e\r\n            \u003cth\u003eLink\u003c/th\u003e\r\n            \u003cth\u003eDegree\u003c/th\u003e\r\n            \u003cth\u003eDate\u003c/th\u003e\r\n        \u003c/tr\u003e\r\n    \u003c/thead\u003e\r\n    \u003ctbody\u003e\r\n        \u003ctr\u003e\r\n            \u003ctd rowspan=4\u003e\u003cimg class=\"customEntitityLogo\" src=\"uit.png\"/\u003e\u003c/td\u003e\r\n            \u003ctd rowspan=4\u003e\u003ca href=\"https://uit.edu.vn/\" target=\"_blank\"\u003eUniversity of Information Technology - VNUHCM\u003c/a\u003e\u003c/td\u003e\r\n        \u003c/tr\u003e\r\n        \u003ctr\u003e\r\n            \u003ctd\u003eBSc, Computer Networking and Data Communication\u003c/td\u003e\r\n            \u003ctd\u003e2025\u003c/td\u003e\r\n        \u003c/tr\u003e\r\n    \u003c/tbody\u003e\r\n\u003c/table\u003e\r\n\u003chr\u003e\n\r\n\r\n\u003ch2 class=\"relative group\"\u003eAchievement \r\n    \u003cdiv id=\"achievement\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n\u003c/h2\u003e\r\n\u003ctable\u003e\r\n  \u003cthead\u003e\r\n    \u003ctr\u003e\r\n      \u003cth\u003eConference\u003c/th\u003e\r\n      \u003cth\u003eLink\u003c/th\u003e\r\n      \u003cth\u003eTitle\u003c/th\u003e\r\n      \u003cth\u003eDate\u003c/th\u003e\r\n    \u003c/tr\u003e\r\n  \u003c/thead\u003e\r\n  \u003ctbody\u003e\r\n    \u003c!-- ICOIN Entry --\u003e\r\n  \u003c/tbody\u003e\r\n\u003c/table\u003e","title":"Resume","type":"page"},{"content":"","date":"31 October 2024","externalUrl":null,"permalink":"/tags/wazuh/","section":"Tags","summary":"","title":"Wazuh","type":"tags"},{"content":"","date":"16 September 2024","externalUrl":null,"permalink":"/tags/cicd/","section":"Tags","summary":"","title":"CICD","type":"tags"},{"content":"","date":"16 September 2024","externalUrl":null,"permalink":"/tags/devops/","section":"Tags","summary":"","title":"Devops","type":"tags"},{"content":"\rComming soon\u0026hellip; #\r","date":"16 September 2024","externalUrl":null,"permalink":"/posts/202504-implementing-devsecops-model-for-e-commerce-web-application/","section":"Posts","summary":"\u003ch1 class=\"relative group\"\u003eComming soon\u0026hellip; \r\n    \u003cdiv id=\"comming-soon\" class=\"anchor\"\u003e\u003c/div\u003e\r\n    \r\n    \u003cspan\r\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\r\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\r\n            style=\"text-decoration-line: none !important;\" href=\"#comming-soon\" aria-label=\"Anchor\"\u003e#\u003c/a\u003e\r\n    \u003c/span\u003e        \r\n    \r\n\u003c/h1\u003e\r\n\u003c!-- ## Table of contents\r\n\r\n- [Pfsense, Client to Site \\\u0026  Site to site](#pfsense-client-to-site---site-to-site)\r\n  - [Table of contents](#table-of-contents)\r\n    - [What is Pfsense ?](#what-is-pfsense-)\r\n    - [Features in pfsense](#features-in-pfsense)\r\n    - [Setup firewall (Outscope)](#setup-firewall-outscope)\r\n      - [Initial setup](#initial-setup)\r\n        - [General Information](#general-information)\r\n        - [Time Server Configuration](#time-server-configuration)\r\n        - [WAN Interface Configuration](#wan-interface-configuration)\r\n      - [Configure LAN Interface](#configure-lan-interface)\r\n      - [Change the Admin password](#change-the-admin-password)\r\n      - [Save parameters](#save-parameters)\r\n      - [Configure Interface](#configure-interface)\r\n      - [Configure Rule and NAT(port-forward)](#configure-rule-and-natport-forward)\r\n        - [I. Rule WAN interface](#i-rule-wan-interface)\r\n        - [II. Rule LAN interface](#ii-rule-lan-interface)\r\n    - [Setup firewall (Inscope Non CDE)](#setup-firewall-inscope-non-cde)\r\n    - [Build VPN](#build-vpn)\r\n      - [Setup VPN Client to Site](#setup-vpn-client-to-site)\r\n        - [Step 1: Configure WAN interface](#step-1-configure-wan-interface)\r\n        - [Step 2: Create a Virtual IP](#step-2-create-a-virtual-ip)\r\n        - [Step 3: Create Certificate Authority – CA](#step-3-create-certificate-authority--ca)\r\n        - [Step 4: Create Server Certificate](#step-4-create-server-certificate)\r\n        - [Step 5: Create a VPN – OpenVPN Server](#step-5-create-a-vpn--openvpn-server)\r\n        - [Step 6: Create a VPN – OpenVPN Client](#step-6-create-a-vpn--openvpn-client)\r\n        - [Step 7: Install the OpenVPN Client Export Utility, a tool that helps export the VPN client](#step-7-install-the-openvpn-client-export-utility-a-tool-that-helps-export-the-vpn-client)\r\n        - [Step 8 : Create user OpenVPN](#step-8--create-user-openvpn)\r\n        - [Step 9: Configure access permissions in the VPN](#step-9-configure-access-permissions-in-the-vpn)\r\n        - [Step 10: Configure access to the VPN](#step-10-configure-access-to-the-vpn)\r\n        - [Step 11: Configure NAT outbound](#step-11-configure-nat-outbound)\r\n        - [Step 12: Export the VPN Client installation package](#step-12-export-the-vpn-client-installation-package)\r\n        - [Step 13: Test the OpenVPN connection](#step-13-test-the-openvpn-connection)\r\n      - [Setup VPN Site to site](#setup-vpn-site-to-site)\r\n        - [Setup Network on CMC-Cloud Site HCM](#setup-network-on-cmc-cloud-site-hcm)\r\n        - [Configure Interface OutScope, NonCDE, CDE Site HCM](#configure-interface-outscope-noncde-cde-site-hcm)\r\n        - [Configure the IPSec tunnel Site HCM](#configure-the-ipsec-tunnel-site-hcm)\r\n        - [Configure Firewall for local connections Site HCM](#configure-firewall-for-local-connections-site-hcm)\r\n        - [Config Route table in CMC-Cloud on Site HCM](#config-route-table-in-cmc-cloud-on-site-hcm)\r\n        - [Setup Network on CMC-Cloud Site HN](#setup-network-on-cmc-cloud-site-hn)\r\n        - [Configure Interface OutScope, NonCDE, CDE Site HN](#configure-interface-outscope-noncde-cde-site-hn)\r\n        - [Configure the IPSec tunnel Site HN](#configure-the-ipsec-tunnel-site-hn)\r\n        - [Configure Firewall for local connections Site HN](#configure-firewall-for-local-connections-site-hn)\r\n        - [Config Route table in CMC-Cloud on Site HN](#config-route-table-in-cmc-cloud-on-site-hn)\r\n    - [Build VPN Route Base (Using OSPF)](#build-vpn-route-base-using-ospf)\r\n      - [Routed IPsec (VTI)](#routed-ipsec-vti)\r\n        - [HANOI - Khanh's zone (Vùng 1) - PHAN](#hanoi---khanhs-zone-vùng-1---phan)\r\n        - [HCM - Khanh's zone (Vùng 2) - GIANG](#hcm---khanhs-zone-vùng-2---giang)\r\n        - [HCM - Tram's zone (Vùng 3) - TRI](#hcm---trams-zone-vùng-3---tri)\r\n      - [Step 1: Configure IPsec Tunnel on pfSense](#step-1-configure-ipsec-tunnel-on-pfsense)\r\n      - [Step 2: Configure Phase 2 (Child SA) for VTI](#step-2-configure-phase-2-child-sa-for-vti)\r\n      - [Create the VTI Interface](#create-the-vti-interface)\r\n      - [Step 4: Firewall Rules for the VTI Interface](#step-4-firewall-rules-for-the-vti-interface)\r\n      - [Testing the VTI Tunnel](#testing-the-vti-tunnel)\r\n      - [Step 5: Setup for OSPF on pfSense with VTI](#step-5-setup-for-ospf-on-pfsense-with-vti)\r\n        - [I. Install the FRR Package on pfSense](#i-install-the-frr-package-on-pfsense)\r\n        - [II. Configure FRR Global Settings](#ii-configure-frr-global-settings)\r\n        - [III. Configure OSPF in FRR](#iii-configure-ospf-in-frr)\r\n        - [IV. Configure Static Routing in Pfsense](#iv-configure-static-routing-in-pfsense)\r\n        - [V. Check status OSPF in FRR](#v-check-status-ospf-in-frr)\r\n        - [V. Check ping](#v-check-ping)\r\n    - [Build VPN With GRE-TUNNEL](#build-vpn-with-gre-tunnel)\r\n\r\n### What is Pfsense ?\r\n\r\n**`Pfsense`**: is an application that functions as a network firewall router and is free based on `FreeBSD`. Pfsense is configured through a web GUI interface for easy management and customization. It supports filtering based on source address, destination, source port, destination port, supports routing, and can operate in bridge or transparent mode.\r\n\r\n![pfsense](Imgs/pfsense.png)\r\n\r\nMoreover, If using pfsense as a gateway, we can clearly see the support for NAT and port forwarding on pfsense as well as performing load balancing or failover on the network paths.\r\n\r\n### Features in pfsense\r\n\r\n1. *`Aliases`*: In pfsense, the firewall cannot have a rule consisting of multiple IP groups or a port group. Therefore, it is necessary to group IP, Port, or URL into one alias. An alias allows to substitute one host, one network range, multiple separate IPs, or a group of ports, URLs... Aliases help save time if used correctly.\r\n\r\n2. *`NAT`*: Pfsense supports Static NAT in the form of NAT 1:1. The condition to perform NAT 1:1 is to have a public IP. When performing NAT 1:1, the Private IP being NAT-ed will always go out with the corresponding Public IP, and the ports will also correspond on the Public IP.\r\n\r\n3. *`Powerful firewall`*: PFsense provides a strong firewall with the ability to filter packets based on IP address, port, protocol, application,... It also supports complex and flexible firewall rules. Rules must be created to manage the internal network.\r\n\r\n4. *`Analyze and manage traffic`*: PFsense provides network traffic analysis tools such as NetFlow and many other plugins to help you understand and manage Internet usage in your network.\r\n\r\n5. *`VPN (Virtual Private Network)`*: PFsense supports multiple VPN protocols such as *`IPsec`*, *`OpenVPN`*, *`L2TP`*, and *`PPTP`*, allowing secure VPN connections to be established between locations or remote users.\r\n\r\n6. *`Proxy Server`*: PFsense can act as a `proxy server`, allowing to control and filter web content, providing security and managing Internet traffic.\r\n\r\n7. *`Load balancing and failover`*: PFsense supports load balancing across multiple Internet connections to optimize network performance and availability. It also features redundancy to ensure service continuity.\r\n\r\n8. *`Manage access control lists (ACL)`*: By using access control lists, you can control the Internet access rights of users in the network, from blocking access to specific websites to managing access time.\r\n\r\n9. *`Security`*: PFsense supports many security features such as `IDS/IPS` (Intrusion Detection/Prevention System), `DPI` (Deep Packet Inspection), `DDoS` protection, to protect the network from various threats.\r\n\r\n10. *`Managing DHCP and DNS:`*: PFsense also provides DHCP and DNS management services to automatically assign IP addresses and manage domains within the network.\r\n\r\n![pfsense](Imgs/pfs.jpg)\r\n\r\n### Setup firewall (Outscope)\r\n\r\nThe pfSense solution is an open-source firewall project originating from the Monowall firewall project from many years ago. According to pfsense.org, thousands of enterprises use pfSense. Essentially, pfSense will include a full-featured firewall/L3 routing suite with many other features such as proxy server, IDS/IPS, high availability, certificate management, and centralized VPN.\r\n\r\n![architecture](Imgs/fo.svg)\r\n\r\n#### Initial setup\r\n\r\n\u003e [!CAUTION]\r\n\u003e ***Error login HTTP_REFERER***\r\n\u003e ![pfsense](Imgs/cts_error.png)\r\n\r\nAccess **terminal console** of **pfsense -\u003e select number `8`**.\r\n\r\n![pfsense](Imgs/cts_fix.png)\r\n\r\n```sh\r\npfSsh.php playback disablereferercheck\r\n```\r\n\r\n\u003e [!NOTE]\r\n\u003e ***ERR_CONNECTION_TIMED_OUT***\r\n\r\n- Assignment Interface in pfSense:\r\n\r\n  After configuring VLANs, pfSense will prompt you to assign the WAN interface. Typically, pfSense will display a list of network interfaces connected to it, such as vtnet0 and vtnet1. These are common virtual network interface names in cloud environments.\r\n  - `Cloud Environment Consideration:`\r\n    - In a cloud environment, if you do not have a VPN setup, pfSense will require a public IP address on the WAN interface to allow access to the User Interface (UI). This is crucial because, without VPN, the only way to manage pfSense remotely is through this public IP.\r\n\r\n  - `WAN Configuration Before LAN:`\r\n    - It is essential to configure WAN access rules before setting up the LAN interface, especially for ports 443 (HTTPS) and 80 (HTTP). `This is because, once the LAN interface is assigned, pfSense’s \"Default Rule\" will automatically shift from the WAN to the LAN interface`.\r\n    - This behavior is part of pfSense’s security mechanism, where the default access rules will prioritize the LAN interface once it's assigned.\r\n\r\nIf you assign the LAN interface before configuring the necessary WAN rules, you might lose access to pfSense through the WAN interface. This happens because the default allow rules will then apply to the LAN, `leaving the WAN interface without the required access permissions`.\r\n\r\nWhen accessing the Web UI interface, pfSense will automatically display the Setup Wizard page to set up the main parameters for the system.\r\n\r\n![pfsense](Imgs/pfsense-web-ui.png)\r\n\r\nClick **`Next`** to continue\r\n\r\n##### General Information\r\n\r\n![pfsense](Imgs/pfsense-web-ui-1.png)\r\n\r\nSet up `Hostname`, `Domain`, `DNS Server`, then click `Next`\r\n\r\n- Hostname: keep pfSense unchanged, you can change later.\r\n\r\n- Domain: keep the default home.arpa, you can change later.\r\n\r\n- Primary \u0026 Secondary DNS Server: Enter Cloudflare DNS (1.1.1.1 and 1.0.0.1) or Google DNS (8.8.8.8 and 8.8.4.4), or leave it blank.\r\n\r\n- Override DNS: Select this if you want to use the DNS provided by the DHCP Server sent to the WAN port.\r\n\r\n##### Time Server Configuration\r\n\r\n![pfsense](Imgs/pfsense-web-ui-2.png)\r\n\r\nAdjust time zone and Time Server. I use time server `1.vn.pool.ntp.org.`\r\n\r\n##### WAN Interface Configuration\r\n\r\nConfigure the WAN Interface and LAN Interface according to the virtual network diagram designed in architecture.\r\n\r\n1. **Step 1:**\r\n\r\n   - Setup IP address of WAN and LAN in portal CMC-Cloud\r\n\r\n    ![pfsense](Imgs/pfs_oos.png)\r\n\r\n   - Setup security group in portal CMC-Cloud\r\n\r\n    ![pfsense](Imgs/pfs_oos_1.png)\r\n\r\n2. **Step 2:**\r\n\r\n   - Set the WAN Interface Type to Static with the following IP parameters:\r\n\r\n  ![pfsense](Imgs/sub_net.png)\r\n\r\n  **IP Address:** `172.24.48.8`\r\n\r\n  **Subnet Mask:** `24`\r\n\r\n  **Upstream Gateway:** `172.24.48.1` (IP of the Mikrotik Router)\r\n\r\n  In a real-world scenario, if you are using pfSense to connect to the ISP's optical modem, you will need to change the WAN Interface Type to PPPoE and enter the provided Username/Password for connection authentication.\r\n\r\n  ![pfsense](Imgs/pfs_oos_.png)\r\n\r\n  Set the `WAN` Interface to `DHCP` IP\r\n\r\n  ![pfsense](Imgs/pfs_oos_2.png)\r\n\r\n  Uncheck the option `Block RFC1918 Private Networks` and `Block bogon networks`\r\n\r\n  Block RFC1918 Private Networks: This option means that pfSense will block all access to the WAN port from internal IP ranges (`10/8, 172.16/12, 192.168/16`).\r\n\r\n  Since I'm using pfSense in a virtual network on CMC-Cloud, where all connections to the WAN port are internal IPs (`172.24.48.0/24`), it is necessary to uncheck Block RFC1918 Private Networks to allow the Host to access the pfSense management page.\r\n\r\n#### Configure LAN Interface\r\n\r\nChange LAN IP Address to `dhcp` and Subnet Mask `32`\r\n\r\n![pfsense](Imgs/pfs_oos_3.png)\r\n\r\n#### Change the Admin password\r\n\r\n![pfsense](Imgs/pfs_oos_4.png)\r\n\r\nEnter `new password` for Admin account\r\n\r\n#### Save parameters\r\n\r\n![pfsense](Imgs/pfs_oos_5.png)\r\n\r\nClick `Reload` to let pfSense save the parameters and restart the service.\r\n\r\n![pfsense](Imgs/pfs_oos_6.png)\r\n\r\nClick `Finish` to complete\r\n\r\n**`Result:`** Dashboard of pfsense\r\n\r\n![pfsense](Imgs/pfs_oos_7.png)\r\n\r\n#### Configure Interface\r\n\r\nAdd interface `vtnet1`\r\n\r\n![pfsense](Imgs/pfs_oos_8.png)\r\n\r\nConfig `WAN` interface\r\n\r\n![pfsense](Imgs/wan-oos.png)\r\n\r\n![pfsense](Imgs/wan-oos-1.png)\r\n\r\nConfig `LAN` interface\r\n\r\n![pfsense](Imgs/lan-oos.png)\r\n\r\n![pfsense](Imgs/lan-oos-1.png)\r\n\r\n#### Configure Rule and NAT(port-forward)\r\n\r\n\u003e **Rule**\r\n\r\n##### I. Rule WAN interface\r\n\r\n![pfsense](Imgs/rule-wan.png)\r\n\r\n- Allow Port access UI\r\n\r\n    \u003e [!NOTE]\r\n    \u003e If the service runs on two ports, `80 (HTTP)` and `443 (HTTPS)`, it should be configured to access the public IP address via a different port to avoid conflicts when configuring port forwarding.\r\n\r\n  - Go to: System -\u003e Advanced -\u003e Admin Access -\u003e webConfigurator -\u003e TCP Port: 'Port different: 80 and 443' -\u003e Save -\u003e Apply changes and wait 20 seconds for automatic redirection. (Remember to create an Allow Rule for WAN Access on the configured port).\r\n\r\n  ![pfsense](Imgs/rule-wan-1.png) ![pfsense](Imgs/rule-wan-2.png)\r\n\r\n- Virtual IP port-forward to 80 and 443\r\n\r\n  To set up port forwarding to ports 80 and 443 using a Virtual IP, you need to configure the following steps:\r\n  - Step 1. Create a Virtual IP on CMC-lor:\r\n    - Go to Dashboard CMC-Cloud -\u003e`Virtual Private Cloud` -\u003e `Subnets` -\u003e `subnet-outscope-bvb` -\u003e `IP address`.\r\n\r\n      ![pfsense](Imgs/vip.png)\r\n\r\n    - Select button `Assign Virtual IP address` -\u003e `Automatic` -\u003e `OK`.\r\n\r\n      ![pfsense](Imgs/vip_1.png)\r\n\r\n    - Continue select `Actions` -\u003e `Bind to Server` -\u003e `Select Server` -\u003e `Select Port` -\u003e `Bind Server`.\r\n\r\n      ![pfsense](Imgs/vip_2.png)\r\n\r\n      ![pfsense](Imgs/vip_3.png)\r\n\r\n##### II. Rule LAN interface\r\n\r\n![pfsense](Imgs/rule-lan.png)\r\n\r\n\u003e **NAT**\r\n\r\n1. NAT Port-forward\r\n\r\n![pfsense](Imgs/nat-pf.png)\r\n\r\n- Go to Port Forwarding Settings:\r\n  - Navigate to Firewall -\u003e NAT -\u003e Port Forward.\r\n  - Click Add to create a new NAT rule for port forwarding.\r\n\r\nConfigure port forwarding from the `WAN` interface to the internal `NAT IP` (`172.24.65.98`) on port `80` (`HTTP`)\r\n\r\n![pfsense](Imgs/nat-pf1.png)\r\n\r\nConfigure port forwarding from the `WAN` interface to the internal `NAT IP` (172.24.65.98) on port `443` (`HTTPS`)\r\n\r\n![pfsense](Imgs/nat-pf2.png)\r\n\r\n1. NAT Outbound\r\n\r\n- Select `Hybrid Outbound NAT rule generation. (Automatic Outbound NAT + rules below)`\r\n- Add Mapping LAN address to subnet 172.24.64.0/20 (outscope)\r\n\r\n![pfsense](Imgs/Outbound.png)\r\n\r\n![pfsense](Imgs/Outbound1.png)\r\n\r\n### Setup firewall (Inscope Non CDE)\r\n\r\n### Build VPN\r\n\r\n`OpenVPN` is a virtual private network (VPN) system that implements techniques to create secure point-to-point or site-to-site connections. It allows parties to authenticate each other using `pre-shared keys`, `certificates`, or `usernames/passwords`. When used in a multi client-server configuration, it enables the server to issue an authentication certificate to each client. It uses the OpenSSL encryption library as well as the widely-used *TLS protocol*, with many control and security features.\r\n\r\n\u003e [!NOTE]\r\n\u003e ***The pfSense firewall is installed and working with interfaces including WAN and LAN***\r\n\r\n#### Setup VPN Client to Site\r\n\r\n##### Step 1: Configure WAN interface\r\n\r\n- Setup IP address of WAN in portal CMC-Cloud\r\n\r\n![pfsense](Imgs/cts.png)\r\n\r\n- Setup security group in portal CMC-Cloud\r\n\r\n![pfsense](Imgs/cts1.png)\r\n\r\n##### Step 2: Create a Virtual IP\r\n\r\n- Navigate to Firewall -\u003e `Virtual IPs`.\r\n- Click `Add` to create a new Virtual IP.\r\n- Set the `Type` to `IP Alias`.\r\n- Assign the `Virtual IP Address` (42.96.47.201) that you want to use.\r\n- Set the Interface to `WAN` or whichever interface you want the Virtual IP to be associated with.\r\n- Save and apply the changes.\r\n\r\n![pfsense](Imgs/cts2.png)\r\n![pfsense](Imgs/cts3.png)\r\n\r\n##### Step 3: Create Certificate Authority – CA\r\n\r\n- Go to the menu `System \u003e Cert. Manager`.\r\n\r\n- Click button `Add` to create a new CA.\r\n\r\n  ![pfsense](Imgs/cts_ca.png)\r\n\r\n- Enter an identifying name for the CA.\r\n\r\n- Set the `method` to **Create an internal Certificate Authority**.\r\n\r\n- Select **Key Type**. (RSA, ECDSA..)\r\n\r\n- Set the length of the key **Key length (2048, 4096, …)**.\r\n\r\n- Select **Digest Algorithm encryption algorithm (sha256, sha512, …)**.\r\n\r\n- Set a common name **Common Name (internal-ca, own-ca, ...)**.\r\n\r\n  ![pfsense](Imgs/cts_ca1.png)\r\n\r\n- Save to complete CA\r\n\r\n  ![pfsense](Imgs/cts_ca2.png)\r\n\r\n##### Step 4: Create Server Certificate\r\n\r\n- Go to the `System \u003e Cert. Manager menu`.\r\n\r\n- Access the `Certificates` tab in the submenu.\r\n\r\n- Select `Add/Sign` at the bottom right.\r\n\r\n- Set the `Method` to `Create an internal Certificate Authority`.\r\n\r\n- Enter a Descriptive name.\r\n\r\n- Set the `Key length` and `Digest Algorithm` the same as the previously created `CA`.\r\n\r\n- Adjust the `Lifetime` to 3650 days or customize it, not exceeding 398 days.\r\n\r\n- Set the Common Name.\r\n\r\n- Set the `Certificate Type` to Server `Certificate`.\r\n\r\n  ![pfsense](Imgs/cts_ca3.png)\r\n\r\n- Save to complete `Server Certificate`.\r\n\r\n##### Step 5: Create a VPN – OpenVPN Server\r\n\r\n- Select the `VPN \u003e OpenVPN`.\r\n\r\n  ![pfsense](Imgs/cts_vpn.png)\r\n\r\n- Select `Add`.\r\n  - General Information:\r\n    1. Set **Server mode** to **Remote Access (SSL/TLS + User Auth)**.\r\n    2. **Local port**, select the connection port, default port **1194**.\r\n    3. Enter a **description**.\r\n\r\n  ![pfsense](Imgs/cts_vpn1.png)\r\n\r\n  - `Cryptographic` Settings:\r\n\r\n    1. Select Use **TLS Key** and automatically enable **Automatically generate a TLS Key**.\r\n    2. In **Peer Certificate Authority**, select the CA that was previously created.\r\n    3. Select the **Server Certificate** created.\r\n    4. Choose 2048 for **DH Parameter Length**.\r\n    5. Set **Auth digest algorithm** to RSA-SHA256 (256-bit).\r\n\r\n    ![pfsense](Imgs/cts_vpn2.png)![pfsense](Imgs/cts_vpn3.png)\r\n\r\n  - `VPN Tunnel` Settings:\r\n    1. Create a subnet in **IPv4 Tunnel Network** as `10.20.10.0/24`.\r\n    2. Leave **IPv6 Tunnel Network** blank.\r\n    3. Enable **Redirect IPv4 Gateway**.\r\n    4. Specify the `maximum number(20)` of clients allowed to concurrently connect to this server.\r\n\r\n    ![pfsense](Imgs/cts_vpn4.png)\r\n\r\n  - `Client Settings` and `Ping settings`\r\n\r\n    Keep default setting\r\n\r\n    ![pfsense](Imgs/cts_vpn5.png)\r\n\r\n  - `Advanced Client Settings` and `Advanced Configuration`:\r\n\r\n    1. Enable DNS Server and add IP DNS Server `10.20.10.1`.\r\n    2. Choose IPv4 Only in Gateway creation; select Both if using IPv4 and IPv6.\r\n\r\n    ![pfsense](Imgs/cts_vpn6.png)\r\n\r\n- Press `Save` to update the configuration.\r\n\r\n  ![pfsense](Imgs/cts_vpn7.png)\r\n\r\n##### Step 6: Create a VPN – OpenVPN Client\r\n\r\n- Navigate to `VPN \u003e OpenVPN \u003e Clients`.\r\n\r\n![pfsense](Imgs/cts_c.png)\r\n\r\n- Click the `Add` button.\r\n\r\n  - General Information:\r\n    1. Enter a **description**.\r\n    2. **Disabled**: Leave this unchecked or your client connection will be disabled.\r\n    3. Set **Server mode** to **Peer to Peer (SSL/TLS)**.\r\n\r\n    ![pfsense](Imgs/cts_c1.png)\r\n\r\n  - `Endpoint Configuration` Setting:\r\n    1. **Protocol**:Have 2 option UDP and TCP. And we used *TCP only on IPv4*.\r\n    2. Set **Interface**: `42.96.47.201((VIP))`. The virtual IP (VIP) was created previously.\r\n    3. **Local port**: Leave blank unless specified by your VPN provider\r\n    4. **Server host or address**: The IP address(*`42.96.47.201`*) or hostname of the VPN server to which you will connect.\r\n    5. **Server port**: The port(*`1194`*) over which the VPN connection will be made.\r\n    6. **Proxy host or address**: Leave blank\r\n    7. **Proxy port**: Leave blank\r\n    8. **Proxy Authentication**: none\r\n    ![pfsense](Imgs/cts_c2.png)\r\n\r\n  - `User Authentication` Settings\r\n    1. Username: Your username, client identifier, account number, etc.\r\n    2. Password: Your password (if required)\r\n    3. Automatic Retry: Leave unchecked so that your client will attempt to reconnect when authentication fails.\r\n  \r\n    ![pfsense](Imgs/cts_c3.png)\r\n\r\n  - `Cryptographic` Settings\r\n    1. Select Use **TLS Key** and automatically enable **Automatically generate a TLS Key**.\r\n    2. In **Peer Certificate Authority**, select the CA that was previously created.\r\n    3. **Client Certificate**: Leave this set to None.\r\n    4. Set **Auth digest algorithm** to RSA-SHA256 (256-bit).\r\n\r\n    ![pfsense](Imgs/cts_c4.png)![pfsense](Imgs/cts_c5.png)\r\n\r\n  - `VPN Tunnel` Settings: Keep default in Tunnel Setting section.\r\n\r\n    ![pfsense](Imgs/cts_c6.png)\r\n\r\n  - `Ping settings`\r\n\r\n    Keep default setting\r\n\r\n    ![pfsense](Imgs/cts_c7.png)\r\n\r\n  - `Advanced Configuration`:\r\n    - Choose IPv4 Only in `Gateway creation`; select Both if using IPv4 and IPv6.\r\n\r\n    ![pfsense](Imgs/cts_c8.png)\r\n\r\n- Press `Save` to update the configuration.\r\n\r\n  ![pfsense](Imgs/cts_c9.png)\r\n\r\n##### Step 7: Install the OpenVPN Client Export Utility, a tool that helps export the VPN client\r\n\r\n- Go to `System \u003e Package Manager`.\r\n\r\n- Select **Available Packages** in the submenu.\r\n\r\n  ![pfsense](Imgs/cts_pkt.png)\r\n\r\n- Find the `openvpn-client-export utility` and select **install** to install it.\r\n\r\n  ![pfsense](Imgs/cts_pkt1.png)\r\n\r\n- Press **confirm** to install.\r\n  ![pfsense](Imgs/cts_pkt2.png)\r\n- Once installation is complete, **Success** will be displayed in the **Package Installer** interface.\r\n  ![pfsense](Imgs/cts_pkt3.png)![pfsense](Imgs/cts_pkt4.png)\r\n\r\n##### Step 8 : Create user OpenVPN\r\n\r\n- Go to the menu **System \u003e User Manager**.\r\n\r\n  ![pfsense](Imgs/cts_user.png)\r\n\r\n- Select the **Add** button and enter a **Username** and **Password** for your user.\r\n\r\n- Press **Save**, and the **OpenVPN user** will be successfully created and then redirected to the initial interface.\r\n\r\n- Configure the authentication method as certificate and password.\r\n\r\n- Select **Add** -\u003e **User Certificate** and enter additional information.\r\n\r\n- Set the method (**Method -\u003e Create an internal Certificate**).\r\n\r\n- Choose **Key length, Type, and Digest Algorithm** to match the previously created **CA**.\r\n\r\n- Set the expiration time **Lifetime to 3650 days**.\r\n\r\n- Ensure that **Certificate Type** is selected as the user certificate just created **(User Certificate)**.\r\n\r\n- **Save** to complete linking the user certificate with the OpenVPN user **(User Certificate – OpenVPN user)**.\r\n\r\n  ![pfsense](Imgs/cts_user1.png)![pfsense](Imgs/cts_user2.png)\r\n\r\n- Press **Save** to complete the setup of creating the user account for OpenVPN.\r\n\r\n##### Step 9: Configure access permissions in the VPN\r\n\r\n- Go to the `Firewall \u003e Rules` menu.\r\n- Select **OpenVPN**.\r\n- Select the first **Add** to add a new rule.\r\n  ![pfsense](Imgs/cts_rule_vpnn.png)\r\n- **Interface**: OpenVPN\r\n- **Address Family**, choose **IPv4** only.\r\n- **Protocol**, select **TCP**.\r\n  ![pfsense](Imgs/cts_rule_vpn.png)\r\n\r\n- `Source`, choose **any**.\r\n- Enter a **description**, press Save, and Apply Changes to save the configuration.\r\n\r\n  ![pfsense](Imgs/cts_rule_vpn1.png)\r\n\r\n##### Step 10: Configure access to the VPN\r\n\r\n- Go to the `Firewall \u003e Rules` menu.\r\n- Select the **WAN** tab.\r\n- Click **Add** to add a new rule.\r\n\r\n  ![pfsense](Imgs/cts_rule_wan.png)\r\n\r\n- Set **Address Family** to **IPv4**.\r\n- **Protocol**, choose **TCP**.\r\n\r\n  ![pfsense](Imgs/cts_rule_wan1.png)\r\n\r\n- Set **Source** to **any**.\r\n- `Destination Port Range`, enter the OpenVPN port configured earlier, which is **`1194`**.\r\n- Enter a **description**, press **Save**, and Apply Changes to save the configuration.\r\n\r\n  ![pfsense](Imgs/cts_rule_wan2.png)\r\n\r\n##### Step 11: Configure NAT outbound\r\n\r\n- Navigate to `Firewall \u003e NAT \u003e Outbound`.\r\n  - Outbound NAT Mode: ***Hybrid Outbound NAT rule generation.\r\n(Automatic Outbound NAT + rules below)*** and then click **Save** and Apply Changes NAT rules.\r\n  ![pfsense](Imgs/cts_nat.png)\r\n  - Mappings Configure\r\n    - Click the green **Add** button with a downward pointing arrow, to create a new NAT rule.\r\n    - Set the **Interface** field to the VPN interface we created earlier.\r\n    - Set the **Address Family** to either IPv4 or IPv4+IPv6 if your VPN provider explicitly supports IPv6.\r\n    - Set the **Source** and **Destination** network with subnet address.\r\n    - Leave all the other settings untouched. Click **Save** and **Apply Changes**.\r\n\r\n    ![pfsense](Imgs/cts_nat1.png)! [pfsense](Imgs/cts_nat2.png)\r\n\r\n##### Step 12: Export the VPN Client installation package\r\n\r\n- Go to `VPN \u003e OpenVPN`.\r\n- Select `Client Export` in the submenu.\r\n- Select the correct **OpenVPN** server next to **Remote Access Server**.\r\n- If using `Dynamic DNS` to access the pfSense **WAN** network, choose **Other** and select **Host Name Resolution** (This setting allows access to the pfSense WAN network using a name instead of an IP address, ensuring no loss of access to the OpenVPN server if the ISP changes the IP or WAN network). `Exp: 42.96.47.201`\r\n- If not using this, set **Host Name Resolution** to **Interface IP Address**.\r\n\r\n  ![pfsense](Imgs/cts_vpn_exp.png)![pfsense](Imgs/cts_vpn_exp1.png)\r\n\r\n- Scroll down to the user location to download the VPN Client installation file, and choose the appropriate installation file.\r\n  ![pfsense](Imgs/cts_vpn_exp2.png)\r\n\r\n##### Step 13: Test the OpenVPN connection\r\n\r\n- Run the installation file for the **VPN Client** that was downloaded.\r\n- Once successfully connected to **OpenVPN**,\r\n\r\n  ![pfsense](Imgs/vpn_test.png)\r\n\r\n- Network information – when connected to **OpenVPN**.\r\n  ![pfsense](Imgs/vpn_test1.png)\r\n\r\n  ![pfsense](Imgs/vpn_test2.png)\r\n\r\n  ![pfsense](Imgs/vpn_test3.png)\r\n\r\n#### Setup VPN Site to site\r\n\r\n\u003e Site HCM\r\n\r\nStart with configuring the tunnel and related settings on the firewall at Site HCM.\r\n\r\n##### Setup Network on CMC-Cloud Site HCM\r\n\r\n1. Setup IP address of `WAN` and `LAN` in portal `CMC-Cloud`:\r\n\r\n    Add **IP private** and **IP public**\r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc.png)\r\n2. Setup **security group** in portal CMC-Cloud\r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc0.png)![pfsense](Imgs/S2S/vpn_s2s_cmc1.png)![pfsense](Imgs/S2S/vpn_s2s_cmc2.png)\r\n3. `Allowed address pairs`\r\n   - Double click to open tab `Update port` -\u003e **Allowed address pairs**\r\n   - Add Security Group\r\n   - Add *`IP Address or CIDR *`* -\u003e `Mac Address`\r\n   - Click Add to create a new **Allowed address pairs**.\r\n  \r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc3.png)\r\n\r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc4.png)\r\n\r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc5.png)\r\n\r\n    ![pfsense](Imgs/S2S/vpn_s2s_cmc6.png)\r\n\r\n##### Configure Interface OutScope, NonCDE, CDE Site HCM\r\n\r\nLet's start.\r\n\r\nFirst, configure the internal LAN and the gateway interface. To do this, in the browser, go to the server IP address or domain name if any. Enter the username and password and get to the Home screen (Dashboard). In the program menu, go to the interfaces section `Interfaces -\u003e Assignments`. In our case, have 3 interfaces are already distributed - we leave it as it is. If you have several interfaces, you should select the necessary interface by mac-address and click the Add button.\r\n\r\nAssign an IP address to the interface **“looking”** to the local network.\r\n\r\n- Add interface vtnet1 (OutScope)\r\n- Add interface vtnet2 (NonCDE)\r\n- Add interface vtnet3 (CDE)\r\n\r\n![pfsense](Imgs/S2S/s2s2.png)\r\n![pfsense](Imgs/S2S/s2s.png)\r\n\r\nIn the program menu, change interface name `interfaces section -\u003e OutScope | NonCDE | CDE`. At the end of the setup, click the Save button.\r\n\r\nFor all servers in the local network, as the default gateway, set the IP address specified in the LAN.\r\n\r\n- Assign `Interface \u003e OutScope`\r\n  - Setting `General Configuration`\r\n    - Select **enable interface**\r\n    - IPv4 Type: **DHCP**\r\n  - DHCP Client Configuration\r\n    - Keep default\r\n  - Reserved Networks\r\n    - Untick **Block private networks and loopback addresses** and **Block bogon networks**\r\n\r\n  ![pfsense](Imgs/S2S/s2s9.png)![pfsense](Imgs/S2S/s2s10.png)\r\n\r\n- Do the same with CDE and Non CDE\r\n  ![pfsense](Imgs/S2S/s2s7.png)![pfsense](Imgs/S2S/s2s8.png)\r\n  ![pfsense](Imgs/S2S/s2s5.png)![pfsense](Imgs/S2S/s2s6.png)\r\n  \r\n`Important!` If you use cloud services, then you need to unite the network nodes from the administration panel of the cloud service through `“Virtual Networks”`.\r\n\r\n##### Configure the IPSec tunnel Site HCM\r\n\r\n***`Phase 1`***\r\n\r\n- Access the `VPN \u003e IPSEC \u003e Tunnel` section\r\n- Click on the **ADD P1** button![pfsense](Imgs/S2S/s2s16.png)\r\n- In the Phase 1 configuration page of the IPsec VPN on the pfsense server, fill in the information according to the configuration similar to IPSec VPN in site HN.\r\n  - `General Information` Setting\r\n    - Enter a **Description**\r\n    - Uncheck **Disabled** this box so that the tunnel will be operational.\r\n  - `IKE Endpoint Configuration`\r\n    - Key Exchange version: Specifies whether to use IKEv2 or IKEv1. IKEv2 is the best practice when supported by both endpoints. If one side does not support IKEv2, use **IKEv1** instead.\r\n    - Internet Protocol: **IPv4** in most cases unless both WANs have IPv6\r\n    - Interface: Most likely set to **WAN**\r\n    - Remote Gateway: The WAN address at Site HN, in this example: `42.96.40.240`.\r\n    ![pfsense](Imgs/S2S/s2s17.png)\r\n  - Setup `Phase 1 Proposal (Authentication)`\r\n  \r\n    The next section controls IPsec phase 1 proposals for encryption.\r\n    - Authentication Method:The default, **Mutual PSK**\r\n    - Negotiation mode: **Main**\r\n    - My Identifier: **My IP Address**\r\n    - Peer Identifier: **Any**\r\n    - Pre-Shared key: generate a key (we will also need this value on our end)![pfsense](Imgs/S2S/s2s18.png)\r\n  - `Phase 1 Proposal (Encryption Algorithm)`\r\n  \r\n    Encryption Algorithm:\r\n    - Algorithm Select **AES**\r\n    - Key length use **128bits**\r\n    - Hash use **SHA256**\r\n    - DH group **2** (1028bit)\r\n  - `Expiration and Replacement`\r\n    - The Expiration and Replacement section controls the timing and method by which phase 1 will be renegotiated.\r\n      - Life Time: The default `28800` is OK for this endpoint.\r\n      - The other lifetime-related values (Rekey Time, Reauth Time, Rand Time) should be left at their defaults on this endpoint as they are automatically calculated as the correct values.\r\n  - `Advanced Options`\r\n    - Child SA Close Action: Set this endpoint to **Default**. Moreover, have options **Restart/Reconnect** so that the phase 2 entries will be reconnected if they get disconnected.\r\n    - Leave checked and at the default values.\r\n  ![pfsense](Imgs/S2S/s2s19.png)\r\n  - Click **Save** when complete\r\n\r\n***`Phase 2`***\r\n\r\nWith the phase 1 entry complete, now a new phase 2 definition to the VPN:\r\n\r\n- Click **Show Phase 2 Entries** to expand the phase 2 list for this VPN.\r\n\r\n- Click **Add P2** to add a new phase 2 entry.\r\n\r\nNow add settings for phase 2 on this VPN. The settings for phase 2:\r\n\r\n- `General Information`\r\n  - Description: A brief description of the network(s) involved in this phase 2 entry.\r\n  - Mode: Select ***Tunnel IPv4***\r\n- `Networks`\r\n  - Local Network: **WAN subnet** with interface WAN. **LAN Subnet** with interfaces: OutScope, CDE and NonCDE.\r\n- `NAT/BINAT`\r\n  - Set to **None**.\r\n- `Remote Network`\r\n  - Set to the network at Site HN, in this case: `172.25.49.0/24`\r\n\r\n![pfsense](Imgs/S2S/s2s20.png)\r\n\r\nThe next section of the phase 2 settings covers traffic encryption. Encryption algorithms and Hash algorithms can both be set to allow multiple options in phase 2, and both sides will negotiate and agree upon the settings so long as each side has at least one of each in common. In some cases that may be a good thing, but it is usually better to restrict this to the single specific options desired on both sides.\r\n\r\n- `Phase 2 Proposal (SA/Key Exchange)`\r\n  - Protocol: Set to **ESP** for encryption.\r\n  - Encryption Algorithms: **AES (128bits)**\r\n  - Hash algorithm use **SHA1**\r\n  - PFS key group with **2(1024bit)**\r\n\r\n- `Expiration and Replacement` and `Keep Alive`\r\n  - Keep default\r\n\r\n![pfsense](Imgs/S2S/s2s22.png)\r\n\r\n***NonCDE***\r\n\r\n![pfsense](Imgs/S2S/s2s23.png)![pfsense](Imgs/S2S/s2s24.png)\r\n\r\n***CDE***\r\n\r\n![pfsense](Imgs/S2S/s2s25.png)![pfsense](Imgs/S2S/s2s26.png)![pfsense](Imgs/S2S/s2s27.png)\r\n\r\n***OutScope***\r\n\r\n![pfsense](Imgs/S2S/s2s28.png)![pfsense](Imgs/S2S/s2s29.png)\r\n\r\n`Result:`\r\n\r\n![pfsense](Imgs/S2S/s2s30.png)\r\n\r\n##### Configure Firewall for local connections Site HCM\r\n\r\nIn the program menu, select `Firewall -\u003e Rules -\u003e WAN`. Click the **Add** button.\r\n\r\n- Protocol: **TCP**, but you can also use Any.\r\n\r\n- Source: **Any**.\r\n\r\n- Destination: **Any**.\r\n\r\n![alt text](Imgs/S2S/s2s11.png)\r\n\r\nConfigure rule OutScope VPN: `Firewall -\u003e Rules -\u003e OutScope`\r\n\r\n- On the new page we check the parameters:\r\n\r\n  - Customizable interface: **OutScope**.\r\n\r\n  - Protocol: **TCP**, but you can also use Any.\r\n\r\n  - Source: **Any**.\r\n\r\n  - Destination: **Any**.\r\n- Save the settings by clicking on the Save button.\r\n\r\n![alt text](Imgs/S2S/s2s14.png)\r\n\r\nDo the same with CDE and Non CDE\r\n\r\n![alt text](Imgs/S2S/s2s13.png)\r\n\r\n![alt text](Imgs/S2S/s2s12.png)\r\n\r\nConfigure rule IPSec VPN: `Firewall -\u003e Rules -\u003e IPSec`\r\n\r\n- Protocol: **TCP**, but you can also use **Any**.\r\n\r\n- Source: **Any**.\r\n\r\n- Destination: **Any**.\r\n\r\n![alt text](Imgs/S2S/s2s15.png)\r\n\r\nIt should be noted that the same settings must be made on all remote pfSense servers connected to a single network.\r\n\r\n##### Config Route table in CMC-Cloud on Site HCM\r\n\r\nA route table contains a set of rules, called routes, that determine where network traffic from your subnet or gateway is directed.\r\n\r\n![alt text](Imgs/S2S/route_hcm.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_1.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_1.1.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_1.2.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_2.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_2.1.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_3.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_3.1.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_3.2.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_5.png)\r\n\r\n![alt text](Imgs/S2S/route_hcm_5.1.png)\r\n\r\n===================================================\r\n\r\n\u003e Site HN\r\n\r\nNow that Site HCM is configured, it is time to tackle Site HN. Repeat the process on the Site HN endpoint to add a tunnel.\r\n\r\n##### Setup Network on CMC-Cloud Site HN\r\n\r\n1. Setup IP address of `WAN` and `LAN` in portal `CMC-Cloud`:\r\n\r\n    Add **IP private** and **IP public**\r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn.png)\r\n2. Setup **security group** in portal CMC-Cloud\r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn1.png)![pfsense](Imgs/S2S-HN/s2s_cmc_hn2.png)\r\n3. `Allowed address pairs`\r\n   - Double click to open tab `Update port` -\u003e **Allowed address pairs**\r\n   - Add Security Group\r\n   - Add *`IP Address or CIDR *`* -\u003e `Mac Address`\r\n   - Click Add to create a new **Allowed address pairs**.\r\n  \r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn3.png)\r\n\r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn4.png)\r\n\r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn5.png)\r\n\r\n    ![pfsense](Imgs/S2S-HN/s2s_cmc_hn6.png)\r\n\r\n##### Configure Interface OutScope, NonCDE, CDE Site HN\r\n\r\nLet's start.\r\n\r\nFirst, configure the internal LAN and the gateway interface. To do this, in the browser, go to the server IP address or domain name if any. Enter the username and password and get to the Home screen (Dashboard). In the program menu, go to the interfaces section `Interfaces -\u003e Assignments`. In our case, have 3 interfaces are already distributed - we leave it as it is. If you have several interfaces, you should select the necessary interface by mac-address and click the Add button.\r\n\r\nAssign an IP address to the interface **“looking”** to the local network.\r\n\r\n- Add interface vtnet1 (OutScope)\r\n- Add interface vtnet2 (NonCDE)\r\n- Add interface vtnet3 (CDE)\r\n\r\n![pfsense](Imgs/S2S-HN/hn.png)\r\n![pfsense](Imgs/S2S-HN/hn0.png)\r\n\r\nIn the program menu, change interface name `interfaces section -\u003e OutScope | NonCDE | CDE`. At the end of the setup, click the Save button.\r\n\r\nFor all servers in the local network, as the default gateway, set the IP address specified in the LAN.\r\n\r\n- Assign `Interface \u003e OutScope`\r\n  - Setting `General Configuration`\r\n    - Select **enable interface**\r\n    - IPv4 Type: **DHCP**\r\n  - DHCP Client Configuration\r\n    - Keep default\r\n  - Reserved Networks\r\n    - Untick **Block private networks and loopback addresses** and **Block bogon networks**\r\n\r\n  ![pfsense](Imgs/S2S-HN/hn7.png)![pfsense](Imgs/S2S-HN/hn8.png)\r\n\r\n- Do the same with CDE and Non CDE\r\n  ![pfsense](Imgs/S2S-HN/hn6.png)![pfsense](Imgs/S2S-HN/hn6a.png)\r\n  ![pfsense](Imgs/S2S-HN/hn4.png)![pfsense](Imgs/S2S-HN/hn5.png)\r\n  \r\n`Important!` If you use cloud services, then you need to unite the network nodes from the administration panel of the cloud service through `“Virtual Networks”`.\r\n\r\n##### Configure the IPSec tunnel Site HN\r\n\r\n***`Phase 1`***\r\n\r\n- Access the `VPN \u003e IPSEC \u003e Tunnel` section\r\n- Click on the **ADD P1** button![pfsense](Imgs/S2S-HN/hn15.png)\r\n- In the Phase 1 configuration page of the IPsec VPN on the pfsense server, fill in the information according to the configuration similar to IPSec VPN in site HN.\r\n  - `General Information` Setting\r\n    - Enter a **Description**\r\n    - Uncheck **Disabled** this box so that the tunnel will be operational.\r\n  - `IKE Endpoint Configuration`\r\n    - Key Exchange version: Specifies whether to use IKEv2 or IKEv1. IKEv2 is the best practice when supported by both endpoints. If one side does not support IKEv2, use **IKEv1** instead.\r\n    - Internet Protocol: **IPv4** in most cases unless both WANs have IPv6\r\n    - Interface: Most likely set to **WAN**\r\n    - Remote Gateway: The WAN address at Site HN, in this example: `42.96.45.27`.\r\n    ![pfsense](Imgs/S2S-HN/hn16.png)\r\n  - Setup `Phase 1 Proposal (Authentication)`\r\n  \r\n    The next section controls IPsec phase 1 proposals for encryption.\r\n    - Authentication Method:The default, **Mutual PSK**\r\n    - Negotiation mode: **Main**\r\n    - My Identifier: **My IP Address**\r\n    - Peer Identifier: **Any**\r\n    - Pre-Shared key: generate a key (we will also need this value on our end)![pfsense](Imgs/S2S-HN/hn17.png)\r\n  - `Phase 1 Proposal (Encryption Algorithm)`\r\n  \r\n    Encryption Algorithm:\r\n    - Algorithm Select **AES**\r\n    - Key length use **128bits**\r\n    - Hash use **SHA256**\r\n    - DH group **2** (1028bit)\r\n  - `Expiration and Replacement`\r\n    - The Expiration and Replacement section controls the timing and method by which phase 1 will be renegotiated.\r\n      - Life Time: The default `28800` is OK for this endpoint.\r\n      - The other lifetime-related values (Rekey Time, Reauth Time, Rand Time) should be left at their defaults on this endpoint as they are automatically calculated as the correct values.\r\n  - `Advanced Options`\r\n    - Child SA Close Action: Set this endpoint to **Default**. Moreover, have options **Restart/Reconnect** so that the phase 2 entries will be reconnected if they get disconnected.\r\n    - Leave checked and at the default values.\r\n  ![pfsense](Imgs/S2S-HN/hn18.png)\r\n  - Click **Save** when complete\r\n\r\n***`Phase 2`***\r\n\r\nWith the phase 1 entry complete, now a new phase 2 definition to the VPN:\r\n\r\n- Click **Show Phase 2 Entries** to expand the phase 2 list for this VPN.\r\n\r\n- Click **Add P2** to add a new phase 2 entry.\r\n\r\nNow add settings for phase 2 on this VPN. The settings for phase 2:\r\n\r\n- `General Information`\r\n  - Description: A brief description of the network(s) involved in this phase 2 entry.\r\n  - Mode: Select ***Tunnel IPv4***\r\n- `Networks`\r\n  - Local Network: **WAN subnet** with interface WAN. **LAN Subnet** with interfaces: OutScope, CDE and NonCDE.\r\n- `NAT/BINAT`\r\n  - Set to **None**.\r\n- `Remote Network`\r\n  - Set to the network at Site HN, in this case: `172.24.49.0/24`\r\n\r\n![pfsense](Imgs/S2S-HN/hn19.png)\r\n\r\nThe next section of the phase 2 settings covers traffic encryption. Encryption algorithms and Hash algorithms can both be set to allow multiple options in phase 2, and both sides will negotiate and agree upon the settings so long as each side has at least one of each in common. In some cases that may be a good thing, but it is usually better to restrict this to the single specific options desired on both sides.\r\n\r\n- `Phase 2 Proposal (SA/Key Exchange)`\r\n  - Protocol: Set to **ESP** for encryption.\r\n  - Encryption Algorithms: **AES (128bits)**\r\n  - Hash algorithm use **SHA1**\r\n  - PFS key group with **2(1024bit)**\r\n\r\n- `Expiration and Replacement` and `Keep Alive`\r\n  - Keep default\r\n\r\n![pfsense](Imgs/S2S-HN/hn20.png)\r\n\r\n***NonCDE***\r\n\r\n![pfsense](Imgs/S2S-HN/hn21.png)![pfsense](Imgs/S2S-HN/hn22.png)\r\n\r\n***CDE***\r\n\r\n![pfsense](Imgs/S2S-HN/hn23.png)![pfsense](Imgs/S2S-HN/hn24.png)\r\n\r\n***OutScope***\r\n\r\n![pfsense](Imgs/S2S-HN/hn25.png)![pfsense](Imgs/S2S-HN/hn26.png)\r\n\r\n`Result:`\r\n\r\n![pfsense](Imgs/S2S-HN/hn28.png)\r\n\r\n##### Configure Firewall for local connections Site HN\r\n\r\nIn the program menu, select `Firewall -\u003e Rules -\u003e WAN`. Click the **Add** button.\r\n\r\n- Protocol: **TCP**, but you can also use Any.\r\n\r\n- Source: **Any**.\r\n\r\n- Destination: **Any**.\r\n\r\n![alt text](Imgs/S2S-HN/hn11.png)\r\n\r\nConfigure rule OutScope VPN: `Firewall -\u003e Rules -\u003e OutScope`\r\n\r\n- On the new page we check the parameters:\r\n\r\n  - Customizable interface: **OutScope**.\r\nImgs/S2S-HN/hn23.png\r\n  - Protocol: **TCP**, but you can also use Any.\r\n\r\n  - Source: **Any**.\r\n\r\n  - Destination: **Any**.\r\n- Save the settings by clicking on the Save button.\r\n\r\n![alt text](Imgs/S2S-HN/hn13.png)\r\n\r\nDo the same with CDE and Non CDE\r\n\r\n![alt text](Imgs/S2S-HN/hn12.png)\r\n\r\n![alt text](Imgs/S2S-HN/hn11.png)\r\n\r\nConfigure rule IPSec VPN: `Firewall -\u003e Rules -\u003e IPSec`\r\n\r\n- Protocol: **TCP**, but you can also use **Any**.\r\n\r\n- Source: **Any**.\r\n\r\n- Destination: **Any**.\r\n\r\n![alt text](Imgs/S2S-HN/hn14.png)\r\n\r\nIt should be noted that the same settings must be made on all remote pfSense servers connected to a single network.\r\n\r\n##### Config Route table in CMC-Cloud on Site HN\r\n\r\nA route table contains a set of rules, called routes, that determine where network traffic from your subnet or gateway is directed.\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_subnet.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route1.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route2.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route3.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route4.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route5.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route6.png)\r\n\r\n![alt text](Imgs/S2S-HN/s2s_hn_route7.png)\r\n\r\n### Build VPN Route Base (Using OSPF)\r\n\r\n#### Routed IPsec (VTI)\r\n\r\nRoute-based IPsec is an alternative method of managing IPsec traffic. It uses `if_ipsec(4)` from FreeBSD for **Virtual Tunnel Interfaces (VTI)** and traffic is directed using the operating system routing table. It does not rely on strict kernel security association matching like policy-based (tunnel mode) IPsec.\r\n\r\nVirtual Tunnel Interface (VTI) tunnels in pfSense are used to create a more streamlined way to handle IPsec VPN configurations. VTI tunnels simplify the process of creating site-to-site VPNs by treating the tunnel as a network interface, allowing for easier management and the ability to use dynamic routing protocols like **`OSPF`** or **`BGP`**.\r\n\r\n![alt text](Imgs/Route-base/VTI_TUNNEL.svg)\r\n\r\n\u003e VPN Route-Based IPSEC\r\n\r\n##### HANOI - Khanh's zone (Vùng 1) - PHAN\r\n\r\n| FW - IP public   | Interface | IP address     | Subnet        |\r\n|------------------|-----------|---------------|---------------|\r\n| 42.98.43.148     | WAN       | 172.25.48.81  | 172.25.48.0/24|\r\n|                  | LAN       | 172.25.68.10  | 172.25.84.0/24|\r\n|                  | VTI       | 10.0.0.1      |               |\r\n| PC               | LAN       | 172.25.64.193 | 172.25.84.0/24|\r\n\r\n##### HCM - Khanh's zone (Vùng 2) - GIANG\r\n\r\n| FW - IP public   | Interface | IP address     | Subnet        |\r\n|------------------|-----------|---------------|---------------|\r\n| 42.98.44.213     | WAN       | 172.21.2.154  | 172.21.0.0/20 |\r\n|                  | VTI-toHN  | 10.0.0.2      |               |\r\n|                  | VTI-toTRAM| 10.0.0.3      |               |\r\n\r\n##### HCM - Tram's zone (Vùng 3) - TRI\r\n\r\n| FW - IP public   | Interface | IP address     | Subnet        |\r\n|------------------|-----------|---------------|---------------|\r\n| 203.171.92.107   | WAN       | 192.168.2.200 | 192.168.0.0/24|\r\n|                  | LAN       | 192.168.0.211 | 192.168.0.0/24|\r\n|                  | VTI       | 10.0.0.4      |               |\r\n| PC               | LAN       | 192.168.0.210 | 192.168.0.0/24|\r\n\r\nConfig in Phase1: **`AES128 - SHA1 - DH Group 2`**\r\n\r\n- Key between zone 3 and zone 2:\r\n\r\n  ```key\r\n  4531f5a38fa3e74c8741c743aae8b7fd7ef4fec037f500d8ad1fa7e91\r\n  ```\r\n\r\n- Key between zone 1 and zone 2:\r\n\r\n  ```key\r\n   7751417e85b68855909314a7da81cbb2271efd65a801f4bc0118d8da\r\n  ```\r\n\r\n#### Step 1: Configure IPsec Tunnel on pfSense\r\n\r\n1. Go to `VPN \u003e IPsec` in the pfSense web GUI.\r\n\r\n2. Click on the + Add P1 button to create a new Phase 1 entry.\r\n\r\n3. Set the following parameters for the Phase 1 configuration:\r\n\r\n   - Key Exchange version: IKEv1\r\n   - Remote Gateway: IP address of the remote VPN endpoint\r\n   - Authentication Method: Mutual PSK (Pre-Shared Key)\r\n   - Pre-Shared Key: Enter a secure key\r\n   - Encryption Algorithm: Choose a strong encryption method (e.g., AES)\r\n   - Hash Algorithm: SHA-1 (or another secure hash)\r\n   - DH Group: Choose an appropriate Diffie-Hellman group\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_zone_1.png)![alt text](Imgs/Route-base/vti_zone_1_1.png)![alt text](Imgs/Route-base/vti_zone_1_2.png)![alt text](Imgs/Route-base/vti_zone_1_3.png)\r\n\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\r\n- toHCM-MrTram\r\n\r\n![vti](Imgs/Route-base/vti_1.png)![vti](Imgs/Route-base/vti_2.png)![vti](Imgs/Route-base/vti_3.png)![vti](Imgs/Route-base/vti_4.png)\r\n\r\n- HCM-to-HN\r\n\r\n![alt text](Imgs/Route-base/vti_1.1.png)![alt text](Imgs/Route-base/vti_2.2.png)![alt text](Imgs/Route-base/vti_3.3.png)![alt text](Imgs/Route-base/vti_4.4.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_zone_3.png)![alt text](Imgs/Route-base/vti_zone_3_1.png)![alt text](Imgs/Route-base/vti_zone_3_2.png)![alt text](Imgs/Route-base/vti_zone_3_3.png)\r\n\r\n#### Step 2: Configure Phase 2 (Child SA) for VTI\r\n\r\n1. Click on + Add P2 under the Phase 1 you just created.\r\n\r\n2. Set the following parameters for the Phase 2 configuration:\r\n\r\n   - Mode: Tunnel IPv4\r\n   - Local Network: Network Address, and enter an IP address in CIDR notation (e.g., 0.0.0.0/0 for all traffic)\r\n   - Remote Network: Network Address, and enter 0.0.0.0/0\r\n   - Protocol: ESP\r\n   - Encryption Algorithms: Choose strong encryption settings (e.g., AES)\r\n   - Hash Algorithms: Choose a secure hash (e.g., SHA-256)\r\n\r\n3. In the Phase 2 proposal (SA/Key Exchange) section, set the following:\r\n\r\n   - Lifetime: Set a reasonable value (e.g., 3600 seconds)\r\n   - Enable Automatically ping host, if desired, to keep the tunnel alive.\r\n\r\n4. Save the Phase 2 settings.\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_p2_1.png)![alt text](Imgs/Route-base/vti_p2_1_1.png)![alt text](Imgs/Route-base/vti_p2_1_2.png)![alt text](Imgs/Route-base/vti_p2_1_4.png)\r\n\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\u003e\u003e HCM - Khanh's zone (Vùng 2) connect to HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_p2_2.png)![alt text](Imgs/Route-base/vti_p2_2_1.png)![alt text](Imgs/Route-base/vti_p2_2_2.png)![alt text](Imgs/Route-base/vti_p2_2_3.png)\r\n\r\n\u003e\u003e HCM - Khanh's zone (Vùng 2) connect to HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_p2_2.2.png)![alt text](Imgs/Route-base/vti_p2_2.2_1.png)![alt text](Imgs/Route-base/vti_p2_2.2_2.png)![alt text](Imgs/Route-base/vti_p2_2.2_3.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_p2_3_1.png)![alt text](Imgs/Route-base/vti_p2_3_2.png)![alt text](Imgs/Route-base/vti_p2_3_3.png)![alt text](Imgs/Route-base/vti_p2_3_4.png)\r\n\r\n#### Create the VTI Interface\r\n\r\n1. Go to Interfaces \u003e Assignments in the pfSense web GUI.\r\n2. You should see a new interface named IPsec VTI available in the list.\r\n3. Click Add to assign the IPsec VTI interface.\r\n4. Click on the newly created interface and configure it:\r\n   - Enable the interface\r\n   - Set the IP Address (e.g., 10.0.0.1/30), where each end of the tunnel gets a unique IP in the subnet.\r\n5. Save and apply the changes.\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_zo1_interface.png)![alt text](Imgs/Route-base/vti_zo1_interface1.png)![alt text](Imgs/Route-base/vti_zo1_interface2.png)\r\n\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\r\n![alt text](Imgs/Route-base/vti_zo2_interface.png)![alt text](Imgs/Route-base/vti_zo2_interface1.png)![alt text](Imgs/Route-base/vti_zo2_interface2.png)![alt text](Imgs/Route-base/vti_zo2_interface3.png)![alt text](Imgs/Route-base/vti_zo2_interface4.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_zo3_interface.png)![alt text](Imgs/Route-base/vti_zo3_interface1.png)![alt text](Imgs/Route-base/vti_zo3_interface2.png)\r\n\r\n#### Step 4: Firewall Rules for the VTI Interface\r\n\r\n1. Go to Firewall \u003e Rules and click on the newly created IPsec VTI interface.\r\n2. Add rules to allow traffic to flow through the tunnel as needed.\r\n   For example, add a rule to allow all traffic for testing purposes.\r\n3. Save and apply the firewall rules.\r\n\r\nExp: Add rules to allow traffic for 3 zone.\r\n\r\n![alt text](Imgs/Route-base/vti_rules.png)![alt text](Imgs/Route-base/vti_rules1.png)\r\n\r\n#### Testing the VTI Tunnel\r\n\r\n1. Ping the remote tunnel IP address to verify connectivity.\r\n2. Ensure that traffic is being properly routed through the VTI tunnel.\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_tunnel_ping_z1.png)![alt text](Imgs/Route-base/vti_tunnel_ping_z1_2.png)\r\n\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\r\n![alt text](Imgs/Route-base/vti_tunnel_ping_z2.png)![alt text](Imgs/Route-base/vti_tunnel_ping_z2_1.png)![alt text](Imgs/Route-base/vti_tunnel_ping_z2_2.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_tunnel_ping_z3.png)![alt text](Imgs/Route-base/vti_tunnel_ping_z3_1.png)\r\n\r\n#### Step 5: Setup for OSPF on pfSense with VTI\r\n\r\n##### I. Install the FRR Package on pfSense\r\n\r\n1. Go to System \u003e Package Manager \u003e Available Packages.\r\n2. Search for the FRR (Free Range Routing) package.\r\n3. Click Install to add the package to your pfSense setup.\r\n4. Once the installation is complete, go to Services \u003e FRR Global/Zebra.\r\n\r\n\u003e [!NOTE]\r\n\u003e Install FRR on all 3 zones\r\n\r\n![alt text](Imgs/Route-base/vti_pkg.png)![alt text](Imgs/Route-base/vti_pkg1.png)![alt text](Imgs/Route-base/vti_pkg2.png)\r\n\r\n##### II. Configure FRR Global Settings\r\n\r\n1. Enable the FRR daemon by checking the box at the top of the page.\r\n2. Make sure the Zebra routing manager is enabled.\r\n3. Save and apply the settings.\r\n\r\n\u003e [!NOTE]\r\n\u003e Enable FRR on all 3 zones\r\n\r\n![alt text](Imgs/Route-base/vti_frr_cfg1.png)![alt text](Imgs/Route-base/vti_frr_cfg2.png)\r\n\r\n##### III. Configure OSPF in FRR\r\n\r\n1. Navigate to `Services \u003e FRR OSPF`.\r\n2. Check the box to **Enable OSPF**.\r\n3. In the Router ID field keep default or enter a unique identifier for this pfSense router (typically the LAN IP address).\r\n4. Under Networks, add the network associated with the VTI interface. For example:\r\n   - Network: 10.10.10.0/30 (replace this with your actual VTI network)\r\n   - Area: 0.0.0.0 (Area 0 is the backbone area for OSPF)\r\n5. Click Save to apply these settings.\r\n\r\n\u003e OSPF config\r\n\r\nOSPF setting\r\n![alt text](Imgs/Route-base/vti_ospf.png)![alt text](Imgs/Route-base/vti_ospf1.png)![alt text](Imgs/Route-base/vti_ospf2.png)![alt text](Imgs/Route-base/vti_ospf3.png)\r\n\r\nAreas setting\r\n\r\n![alt text](Imgs/Route-base/vti_area.png)![alt text](Imgs/Route-base/vti_area1.png)![alt text](Imgs/Route-base/vti_area2.png)\r\n\r\nInterface setting\r\n\r\n- HANOI - Khanh's zone (Vùng 1)\r\n  \r\n![alt text](Imgs/Route-base/vti_interface_hn.png)![alt text](Imgs/Route-base/vti_interface_hn1.png)![alt text](Imgs/Route-base/vti_interface_hn2.png)\r\n\r\n- HCM - Khanh's zone (Vùng 2)\r\n\r\n![alt text](Imgs/Route-base/vti_interface_z2.png)![alt text](Imgs/Route-base/vti_interface_z21.png)![alt text](Imgs/Route-base/vti_interface_z22.png)\r\n\r\n- HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_interface_z3.png)![alt text](Imgs/Route-base/vti_interface_z31.png)![alt text](Imgs/Route-base/vti_interface_z32.png)\r\n\r\n##### IV. Configure Static Routing in Pfsense\r\n\r\n1. Navigate to `System \u003e Routing \u003e Static Routes`.\r\n2. Select + **Add** button to create a new static route.\r\n3. Configure the Static Route:\r\n   - Destination network: Enter the destination network (e.g., 192.168.2.0/24).\r\n   - Gateway: Select the gateway that pfSense should use to reach the destination network. Ở đây chúng ta sử dụng gateway vti.\r\n   - Optionally, you can add a Description for the route.\r\n4. Click **Save** to **apply** activate the new route..\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_routes_hn.png)![alt text](Imgs/Route-base/vti_routes_hn1.png)![alt text](Imgs/Route-base/vti_routes_hn2.png)\r\n\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\r\n![alt text](Imgs/Route-base/vti_routes_z2.png)![alt text](Imgs/Route-base/vti_routes_z2_1.png)![alt text](Imgs/Route-base/vti_routes_z2_2.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_routes_z3.png)![alt text](Imgs/Route-base/vti_routes_z3_1.png)![alt text](Imgs/Route-base/vti_routes_z3_2.png)\r\n\r\n##### V. Check status OSPF in FRR\r\n\r\n1. Navigate to `Status \u003e FRR`.\r\n2. Select  **OSPF** button to query status service ospf.\r\n\r\n\u003e HANOI - Khanh's zone (Vùng 1)\r\n\r\n![alt text](Imgs/Route-base/vti_ospf_stt_zone1.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone1.1.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone1.2.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone1.3.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone1.4.png)\r\n\u003e HCM - Khanh's zone (Vùng 2)\r\n\r\n![alt text](Imgs/Route-base/vti_ospf_stt_zone2.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone2.1.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone2.2.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone2.3.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone2.4.png)\r\n\r\n\u003e HCM - Tram's zone (Vùng 3)\r\n\r\n![alt text](Imgs/Route-base/vti_ospf_stt_zone3.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone3.1.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone3.2.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone3.3.png)![alt text](Imgs/Route-base/vti_ospf_stt_zone3.4.png)\r\n\r\n##### V. Check ping\r\n\r\n\u003e Access the PC on zone 1, add route and perform ping test.\r\n\r\n![alt text](Imgs/Route-base/ping_zo1_to_zo3.png)\r\n\r\n- Show route before add new route\r\n\r\n![alt text](Imgs/Route-base/ping_zo1_to_zo3_1.png)\r\n\r\n- Add route and ping to Lan\r\n\r\n![alt text](Imgs/Route-base/ping_zo1_to_zo3_2.png)\r\n![alt text](Imgs/Route-base/ping_zo1_to_zo3_3.png)\r\n\r\n- Ping to PC\r\n\r\n![alt text](Imgs/Route-base/ping_zo1_to_zo3_4.png)\r\n\r\n\u003e Access the PC on zone 3, add route and perform ping test.\r\n\r\n![alt text](Imgs/Route-base/ping_zo3_to_zo1.png)\r\n\r\n- Show route before add new route\r\n\r\n![alt text](Imgs/Route-base/ping_zo3_to_zo1_1.png)\r\n![alt text](Imgs/Route-base/ping_zo3_to_zo1_2.png)\r\n\r\n- Add route and ping to Lan\r\n\r\n![alt text](Imgs/Route-base/ping_zo3_to_zo1_3.png)\r\n\r\n- Ping to PC\r\n\r\n![alt text](Imgs/Route-base/ping_zo3_to_zo1_5.png)\r\n\r\n### Build VPN With GRE-TUNNEL\r\n\r\nGeneric Routing Encapsulation (GRE) is a method of tunneling traffic between two endpoints without encryption. It can be used to route packets between two locations that are not directly connected, which do not require encryption. It can also be combined with a method of encryption that does not perform its own tunneling.\r\n\r\n\u003e [!NOTE]\r\n\u003e The GRE protocol was originally designed by Cisco, and it is the default tunneling mode on many of their devices.\r\n\r\nGRE tunnels can carry either IPv4, IPv6, or both types of traffic at the same time.\r\n\r\nEnd. --\u003e","title":"Implementing DevSecOps model for E-Commerce Web Application","type":"posts"},{"content":"","date":"16 September 2024","externalUrl":null,"permalink":"/tags/microservices/","section":"Tags","summary":"","title":"Microservices","type":"tags"},{"content":"\rWith one year of experience in DevOps, I have been involved in deploying and managing infrastructure for banking projects at Ban Viet Bank and OCB Bank. I am passionate about automating workflows, optimizing system performance, and ensuring stability and security in production environments.\nMy work includes provisioning and maintaining cloud-native infrastructure, managing Kubernetes clusters, implementing CI/CD pipelines using GitLab with Flux CD, Helm, and setting up centralized logging and monitoring with tools like Prometheus, Grafana, Loki and Wazuh. I have experience working with infrastructure-as-code (IaC) using Terraform and I collaborate closely with development and security teams to ensure scalable and secure system design.\nI\u0026rsquo;m currently expanding my skills in cloud security and infrastructure design, with a career goal of moving toward DevSecOps and solution architecture. I aim to build end-to-end systems that are not only reliable and automated, but also secure by design. I\u0026rsquo;m continuously learning and enjoy sharing knowledge around modern infrastructure, cloud-native patterns, and DevOps best practices. I\u0026rsquo;m always open to connecting and exchanging ideas with professionals in the field.\n","date":"13 June 2022","externalUrl":null,"permalink":"/about/","section":"LinhTran's","summary":"\u003cdiv style=\"display: flex; align-items: flex-start; gap: 2rem;\"\u003e\r\n\u003cdiv style=\"flex: 2;\"\u003e\r\n\u003cp\u003eWith one year of experience in DevOps, I have been involved in deploying and managing infrastructure for banking projects at Ban Viet Bank and OCB Bank. I am passionate about automating workflows, optimizing system performance, and ensuring stability and security in production environments.\u003c/p\u003e","title":"About","type":"page"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"}]